<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgroTech ‚Äî Smart Farming Dashboard</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZP5JD05KH3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ZP5JD05KH3');
</script>

<!-- Favicon and App Icons -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<!-- Android Chrome Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">

<!-- PWA Manifest -->
<link rel="manifest" href="/site.webmanifest">

<!-- Fonts, icons, Chart.js -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase COMPAT libs (Auth + Realtime DB) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  :root{
    --accent:#2ecc71;
    --accent-dark:#27ae60;
    --muted:#6b7280;
    --dark:#0f1720;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:'Poppins',sans-serif; color:#0b2e21; height:100vh; overflow:hidden; }

  /* Parallax background container */
  .bg-wrap{ position:fixed; inset:0; z-index:-3; overflow:hidden; }
  .bg-image{
    position:absolute; inset:-20%; background-image:url('https://images.unsplash.com/photo-1524593119771-aa5c54b3e222?auto=format&fit=crop&w=1600&q=70');
    background-size:cover; background-position:center; transform:translate3d(0,0,0);
    transition:transform .15s linear; filter:saturate(1.05) contrast(1);
  }
  .bg-overlay{ position:absolute; inset:0; background:linear-gradient(rgba(255,255,255,0.78), rgba(255,255,255,0.85)); }

  /* Layout */
  .layout{ display:flex; width:100%; height:100vh; }
  /* Sidebar - Dark style (style B) */
  .sidebar{
    width:80px; background:var(--dark); color:#dbeee0; display:flex; flex-direction:column; align-items:center; padding:16px 8px;
    box-shadow:0 8px 30px rgba(2,6,10,0.45);
  }
  .profile-circle{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:#11221a; color:var(--accent); margin-bottom:18px; font-size:18px; }
  .menu{ display:flex; flex-direction:column; gap:10px; align-items:center; width:100%; }
  .side-btn{ width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#cfeee1; cursor:pointer; font-size:18px; border:1px solid transparent; transition:all .18s ease; background:transparent; }
  .side-btn:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.25); }
  .side-btn.active{ background:linear-gradient(180deg,var(--accent-dark),var(--accent)); color:#fff; }

  .spacer{ flex:1; }

  /* Main area */
  .main{ flex:1; display:flex; flex-direction:column; min-height:100vh; overflow:auto; }
  .topbar{ height:64px; display:flex; align-items:center; gap:12px; padding:0 18px; background:rgba(255,255,255,0.72); backdrop-filter:blur(8px); border-bottom:1px solid rgba(0,0,0,0.04); position:sticky; top:0; z-index:10; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:44px; height:44px; border-radius:10px; background-image:url('https://images.unsplash.com/photo-1542444459-db5a45f1d499?auto=format&fit=crop&w=300&q=60'); background-size:cover; }
  .title{ font-weight:700; color:#163b2e; font-size:18px; }

  .top-actions{ margin-left:auto; display:flex; gap:10px; align-items:center; color:var(--muted); }

  /* Content area */
  .content{ width:100%; max-width:1100px; margin:26px auto; padding:0 18px 60px; display:flex; align-items:flex-start; justify-content:center; }

  /* Dashboard welcome */
  .dashboard-wrap{ width:100%; display:flex; align-items:center; justify-content:center; padding:40px 0; }
  .welcome-box{
    width:760px; max-width:92%; background:rgba(255,255,255,0.88); border-radius:16px; padding:28px 30px; box-shadow:0 30px 70px rgba(14,22,18,0.12); display:flex; gap:22px; align-items:center;
  }
  .welcome-left h1{ margin:0; font-size:28px; color:#184c38; }
  .welcome-left p{ margin:8px 0 0 0; color:#3d6552; }

  .welcome-right img{ width:220px; border-radius:12px; box-shadow:0 12px 35px rgba(7,20,12,0.12); }

  /* Centered page card */
  .page-card{ width:760px; max-width:92%; background:rgba(255,255,255,0.95); border-radius:14px; padding:22px; box-shadow:0 18px 50px rgba(10,20,12,0.06); display:none; }

  /* Form fields */
  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
  .field input, .field select{ padding:10px 12px; border-radius:8px; border:1px solid #dfe7e2; font-size:14px; }

  .primary-btn{ background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
  .muted{ color:var(--muted); font-size:13px; }

  /* image preview */
  #preview{ max-width:100%; border-radius:8px; display:block; margin-top:10px; }

  /* Chart */
  .chart-wrap{ width:100%; height:260px; }

  /* Profile card */
  .profile-row{ display:flex; align-items:center; gap:12px; }
  .avatar{ width:72px; height:72px; border-radius:12px; background:#e8f7ee; display:flex; align-items:center; justify-content:center; font-size:26px; color:#1a553f; }

  /* Bottom nav */
  .bottom-nav{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:40; background:rgba(16,20,18,0.9); padding:8px 12px; border-radius:40px; display:flex; gap:12px; box-shadow:0 10px 30px rgba(4,8,6,0.3); }
  .bbtn{ color:#dbeee0; width:48px; height:48px; display:flex; align-items:center; justify-content:center; border-radius:12px; cursor:pointer; font-size:18px; }
  .bbtn.active{ background:linear-gradient(90deg,var(--accent-dark),var(--accent)); color:#fff; }

  /* Auth overlay (login/signup) */
  #authPanel { position:fixed; inset:0; z-index:60; display:flex; align-items:center; justify-content:center; background:linear-gradient(rgba(0,0,0,0.32), rgba(0,0,0,0.38)), url('https://images.unsplash.com/photo-1518732714860-b62714ce0c59?auto=format&fit=crop&w=1600&q=70') center/cover; }
  .authBox{ width:360px; padding:26px; border-radius:16px; background:rgba(255,255,255,0.14); backdrop-filter:blur(12px); box-shadow:0 18px 50px rgba(0,0,0,0.3); color:white; animation:zoomIn .34s ease forwards; position:relative; }
  @keyframes zoomIn{ from{opacity:0; transform:scale(.78)} to{opacity:1; transform:scale(1)} }
  .authBox h2{ margin:0 0 6px 0; font-size:22px; color:#e8ffef }
  .authBox .muted{ color:#e6fff3; opacity:.9; margin-bottom:12px; }
  .authBox input{ width:100%; padding:10px 12px; border-radius:10px; border:none; margin-top:8px; }
  .authBox .btn{ width:100%; padding:12px; margin-top:12px; border-radius:10px; border:none; font-weight:700; cursor:pointer; background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:#063017; }
  .authBox .ghost{ width:100%; padding:10px; margin-top:8px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; cursor:pointer; }

  .msg{ font-size:13px; color:#ffdede; margin-top:6px; }

  /* Responsive */
  @media(max-width:900px){ .sidebar{ width:64px } .side-btn{ width:48px; height:48px } .welcome-box{ width:92%; flex-direction:column; gap:12px; align-items:flex-start } .main{ padding-bottom:90px } }
  @media(max-width:520px){ .welcome-right img{ display:none } .page-card{ padding:16px } .authBox{ width:92%; padding:18px } .content{ padding:8px } }
</style>
</head>
<body>

<!-- Parallax background -->
<div class="bg-wrap" id="bgWrap">
  <div class="bg-image" id="bgImage"></div>
  <div class="bg-overlay"></div>
</div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" aria-hidden>
    <div class="profile-circle" id="sidebarProfileIcon"><i class="fa-solid fa-leaf"></i></div>
    <nav class="menu" role="navigation" aria-label="Main menu">
      <div class="side-btn active" id="m-dashboard" title="Dashboard" onclick="navClick('dashboard')"><i class="fa-solid fa-house-chimney"></i></div>
      <div class="side-btn" id="m-detect" title="Disease Detection" onclick="navClick('detect')"><i class="fa-solid fa-microscope"></i></div>
      <div class="side-btn" id="m-seed" title="Seed Calculator" onclick="navClick('seed')"><i class="fa-solid fa-seedling"></i></div>
      <div class="side-btn" id="m-moist" title="Moisture Monitor" onclick="navClick('moisture')"><i class="fa-solid fa-chart-line"></i></div>
      <div class="side-btn" id="m-profile" title="Profile" onclick="navClick('profile')"><i class="fa-solid fa-user"></i></div>
    </nav>
    <div class="spacer"></div>
    <div style="width:100%; display:flex; justify-content:center;"><div class="side-btn" id="m-logout" title="Logout" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i></div></div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div class="brand"><div class="logo" aria-hidden></div><div class="title">AgroTech</div></div>
      <div class="top-actions"><div id="userEmailTop" class="muted"></div></div>
    </div>

    <div class="content" id="contentArea">
      <!-- Dashboard -->
      <section id="page-dashboard" class="dashboard-wrap">
        <div class="welcome-box">
          <div class="welcome-left">
            <h1 id="welcomeTitle">Welcome</h1>
            <p id="welcomeSub" class="muted">Select a tool from the left menu to get started</p>
          </div>
          <div class="welcome-right"><img src="https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=900&q=70" alt="plant" /></div>
        </div>
      </section>

      <!-- Disease Detection -->
      <section id="page-detect" class="page-card" aria-hidden>
        <h3>Plant Disease Detection</h3>
        <div style="display:flex; gap:16px; flex-wrap:wrap; margin-top:12px;">
          <div style="flex:1; min-width:260px;">
            <div style="border:2px dashed #e6efe8; padding:18px; border-radius:12px; text-align:center;">
              <p class="muted">Upload plant image</p>
              <input type="file" id="fileInput" accept="image/*" style="display:none" />
              <button class="primary-btn" id="chooseBtn" onclick="document.getElementById('fileInput').click()">Choose Image</button>
              <img id="preview" style="display:none; margin-top:12px; border-radius:8px;" />
              <div style="margin-top:12px;"><button class="primary-btn" id="processBtn">Run Detection</button></div>
            </div>
          </div>

          <div style="width:320px;">
            <div style="background:#fbfff9; padding:12px; border-radius:10px;">
              <p class="muted">Result</p>
              <div id="detectResult" style="font-weight:700; margin-top:6px;">No image analyzed yet.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Seed Calculator -->
      <section id="page-seed" class="page-card" aria-hidden>
        <h3>Seed Requirement Calculator</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
          <div style="flex:1; min-width:260px;">
            <div class="field">
              <label class="muted">Crop</label>
              <!-- Dropdown with emoji icons (Style 2) -->
              <select id="cropSelect">
                <option value="" data-w="0">üåæ Select crop</option>
                <option value="Maize" data-w="25">üåΩ Maize</option>
                <option value="Wheat" data-w="4">üåæ Wheat</option>
                <option value="Rice" data-w="2">üçö Rice</option>
                <option value="Mustard" data-w="0.5">üåº Mustard</option>
                <option value="Soybean" data-w="15">ü´ò Soybean</option>
                <option value="Groundnut" data-w="65">ü•ú Groundnut</option>
                <option value="Bajra" data-w="1">üåæ Bajra</option>
                <option value="Sunflower" data-w="8">üåª Sunflower</option>
                <option value="Cotton" data-w="6">üßµ Cotton</option>
                <option value="Chickpea" data-w="25">ü•£ Chickpea</option>
                <option value="Jowar" data-w="1.2">üåæ Jowar</option>
                <option value="Barley" data-w="3.5">üåæ Barley</option>
                <option value="Other" data-w="0">üîß Other (enter weight below)</option>
              </select>
            </div>

            <div class="field">
              <label class="muted">Row spacing (cm)</label>
              <input id="spacingInp" type="number" placeholder="20">
            </div>
            <div class="field">
              <label class="muted">Field area (m¬≤)</label>
              <input id="areaInp" type="number" placeholder="100">
            </div>

            <!-- if "Other" selected, user can enter weight per 100 seeds -->
            <div class="field" id="otherWeightWrap" style="display:none;">
              <label class="muted">Weight per 100 seeds (g) ‚Äî for Other crop</label>
              <input id="otherWeightInput" type="number" step="0.01" placeholder="e.g. 10">
            </div>

            <button class="primary-btn" onclick="calcSeeds()">Calculate</button>
          </div>

          <div style="width:320px;">
            <div style="background:#fbfff9; padding:12px; border-radius:10px;">
              <p class="muted">Results</p>
              <div id="seedResult" style="font-weight:700; margin-top:8px;">Required Seeds: ‚Äî</div>
              <div id="seedWeightResult" style="margin-top:6px; font-weight:700;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Moisture Monitor -->
      <section id="page-moisture" class="page-card" aria-hidden>
        <h3>Moisture Monitor</h3>
        <div style="margin-top:10px;">
          <div class="chart-wrap"><canvas id="moistureChart"></canvas></div>
          <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
            <div id="lastUpdated" class="muted">Last Updated: ‚Äî</div>
            <button class="primary-btn" onclick="manualRefresh()">Refresh</button>
          </div>
        </div>
      </section>

      <!-- Profile -->
      <section id="page-profile" class="page-card" aria-hidden>
        <h3>Profile</h3>
        <div style="margin-top:12px;">
          <div class="profile-row">
            <div class="avatar" id="profileAvatar">U</div>
            <div>
              <div id="p-email" style="font-weight:700"></div>
              <div id="p-name" class="muted"></div>
            </div>
          </div>
          <div style="margin-top:16px;">
            <label class="muted">Change display name</label>
            <input id="editName" placeholder="New display name">
            <div style="display:flex; gap:8px; margin-top:10px;">
              <button class="primary-btn" onclick="updateName()">Update Name</button>
              <button class="primary-btn" style="background:#ff6b6b" onclick="deleteAccount()">Delete Account</button>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Bottom navigation -->
<div class="bottom-nav" id="bottomNav" aria-hidden>
  <div class="bbtn active" id="b-dashboard" title="Dashboard" onclick="navClick('dashboard')"><i class="fa-solid fa-house"></i></div>
  <div class="bbtn" id="b-detect" title="Detect" onclick="navClick('detect')"><i class="fa-solid fa-microscope"></i></div>
  <div class="bbtn" id="b-seed" title="Seeds" onclick="navClick('seed')"><i class="fa-solid fa-seedling"></i></div>
  <div class="bbtn" id="b-profile" title="Profile" onclick="navClick('profile')"><i class="fa-solid fa-user"></i></div>
</div>

<!-- AUTH PANEL (overlay) -->
<div id="authPanel">
  <div class="authBox" role="dialog" aria-modal="true">
    <h2>Welcome to AgroTech</h2>
    <div class="muted">Sign in or create an account to continue</div>

    <!-- Sign in form -->
    <div id="signInForm">
      <input id="siEmail" type="email" placeholder="Email" />
      <input id="siPassword" type="password" placeholder="Password" />
      <button class="btn" id="signInBtn">Sign In</button>
      <button class="ghost" id="googleSignInBtn"><i class="fa-brands fa-google"></i> Sign in with Google</button>
      <button class="ghost" id="switchToSignUp">Create an account</button>
      <button class="ghost" id="forgotBtn">Forgot password?</button>
      <div id="siMsg" class="msg"></div>
    </div>

    <!-- Sign up form -->
    <div id="signUpForm" style="display:none;">
      <input id="suName" type="text" placeholder="Full name" />
      <input id="suEmail" type="email" placeholder="Email" />
      <input id="suPassword" type="password" placeholder="Password (min 6)" />
      <button class="btn" id="signUpBtn">Create Account</button>
      <button class="ghost" id="switchToSignIn">Already have an account?</button>
      <div id="suMsg" class="msg"></div>
    </div>
  </div>
</div>

<!-- SCRIPT: App logic + Firebase -->
<script>
/* ======================= FIREBASE CONFIG ======================= 
   Replace these values with your Firebase project's config if different.
*/
const firebaseConfig = {
  apiKey: "AIzaSyAaUOPKe4lvxqSbj_yZRXREOrLok9mmvRk",
  authDomain: "agrotech-9b042.firebaseapp.com",
  databaseURL: "https://agrotech-9b042-default-rtdb.firebaseio.com", // Realtime DB URL
  projectId: "agrotech-9b042",
  storageBucket: "agrotech-9b042.appspot.com",
  messagingSenderId: "722678725948",
  appId: "1:722678725948:web:46d86af5eb3bdfaf61f239",
  measurementId: "G-Z6E71FDC8H"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ======================= UI References ======================= */
const pageDashboard = document.getElementById('page-dashboard');
const pageDetect = document.getElementById('page-detect');
const pageSeed = document.getElementById('page-seed');
const pageMoisture = document.getElementById('page-moisture');
const pageProfile = document.getElementById('page-profile');
const allPages = [pageDashboard, pageDetect, pageSeed, pageMoisture, pageProfile];

const sideButtons = {
  dashboard: document.getElementById('m-dashboard'),
  detect: document.getElementById('m-detect'),
  seed: document.getElementById('m-seed'),
  moisture: document.getElementById('m-moist'),
  profile: document.getElementById('m-profile')
};
const bottomButtons = {
  dashboard: document.getElementById('b-dashboard'),
  detect: document.getElementById('b-detect'),
  seed: document.getElementById('b-seed'),
  profile: document.getElementById('b-profile')
};

/* ======================= NAVIGATION (single-page display) ======================= */
function hideAllPages(){
  allPages.forEach(p => { p.style.display = 'none'; p.setAttribute('aria-hidden','true'); });
}
function clearActive(){
  Object.values(sideButtons).forEach(b => b.classList.remove('active'));
  Object.values(bottomButtons).forEach(b => b.classList.remove('active'));
}
function setActive(menu){
  clearActive();
  if(sideButtons[menu]) sideButtons[menu].classList.add('active');
  if(bottomButtons[menu]) bottomButtons[menu].classList.add('active');
}
function navClick(target){
  hideAllPages();
  setActive(target);
  if(target === 'dashboard') pageDashboard.style.display = 'flex';
  if(target === 'detect') pageDetect.style.display = 'block';
  if(target === 'seed') pageSeed.style.display = 'block';
  if(target === 'moisture') pageMoisture.style.display = 'block';
  if(target === 'profile') pageProfile.style.display = 'block';
}
/* initial */
hideAllPages();
navClick('dashboard');

/* ======================= AUTH UI ======================= */
const authPanel = document.getElementById('authPanel');
const signInForm = document.getElementById('signInForm');
const signUpForm = document.getElementById('signUpForm');

document.getElementById('switchToSignUp').onclick = () => { signInForm.style.display='none'; signUpForm.style.display='block'; document.getElementById('siMsg').textContent=''; };
document.getElementById('switchToSignIn').onclick = () => { signUpForm.style.display='none'; signInForm.style.display='block'; document.getElementById('suMsg').textContent=''; };

/* SIGN UP */
document.getElementById('signUpBtn').onclick = async () => {
  const name = document.getElementById('suName').value.trim();
  const email = document.getElementById('suEmail').value.trim();
  const password = document.getElementById('suPassword').value;
  const msg = document.getElementById('suMsg');
  msg.textContent='';
  if(!email || !password){ msg.textContent='Email & password required'; return; }
  if(password.length < 6){ msg.textContent='Password must be >=6 chars'; return; }
  try{
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    if(name) await userCred.user.updateProfile({ displayName: name });
    msg.style.color='lightgreen'; msg.textContent='Account created. Signing in...';
    // signed in automatically; onAuthStateChanged will handle UI
  } catch(err){ msg.style.color='salmon'; msg.textContent = err.message; }
};

/* SIGN IN */
document.getElementById('signInBtn').onclick = async () => {
  const email = document.getElementById('siEmail').value.trim();
  const password = document.getElementById('siPassword').value;
  const msg = document.getElementById('siMsg'); msg.textContent='';
  if(!email || !password){ msg.textContent='Email & password required'; return; }
  try{ await auth.signInWithEmailAndPassword(email, password); } catch(err){ msg.textContent = err.message; }
};

/* GOOGLE SIGN-IN */
document.getElementById('googleSignInBtn').onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try{ await auth.signInWithPopup(provider); } catch(err){ alert(err.message); }
};

/* PASSWORD RESET */
document.getElementById('forgotBtn').onclick = async () => {
  const email = prompt('Enter your email for reset:');
  if(!email) return;
  try{ await auth.sendPasswordResetEmail(email); alert('Reset email sent'); } catch(err){ alert(err.message); }
};

/* AUTH STATE CHANGE */
auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById('userEmailTop').textContent = user.email;
    document.getElementById('p-email').textContent = user.email;
    document.getElementById('p-name').textContent = user.displayName || 'No display name';
    document.getElementById('profileAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
    // hide overlay
    authPanel.style.display = 'none';
    // show app
    navClick('dashboard');
  } else {
    // show overlay
    authPanel.style.display = 'flex';
    hideAllPages();
  }
});

/* LOGOUT */
function logout(){ auth.signOut(); }

/* ======================= Disease Detection (UI simulated) ======================= */
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const detectResult = document.getElementById('detectResult');
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev => { preview.src = ev.target.result; preview.style.display='block'; detectResult.textContent='Ready to analyze'; };
  r.readAsDataURL(f);
});
document.getElementById('processBtn').addEventListener('click', ()=>{
  if(!preview.src){ detectResult.textContent='Choose an image first.'; return; }
  detectResult.textContent = 'Processing‚Ä¶';
  setTimeout(()=>{
    const outcomes = ['Healthy','Early Blight','Leaf Rust','Nutrient Deficiency','Bacterial Spot'];
    const pick = outcomes[Math.floor(Math.random()*outcomes.length)];
    detectResult.innerHTML = `<strong>${pick}</strong><div class="muted">Confidence: ${(70 + Math.random()*25).toFixed(0)}%</div>`;
  }, 1000 + Math.random()*900);
});

/* ======================= Seed Calculator (dropdown with icons) ======================= */
const cropSelect = document.getElementById('cropSelect');
const otherWeightWrap = document.getElementById('otherWeightWrap');
cropSelect.addEventListener('change', ()=>{
  const selected = cropSelect.options[cropSelect.selectedIndex];
  const weight100 = parseFloat(selected.dataset.w || 0);
  if(selected.value === 'Other'){ otherWeightWrap.style.display = 'block'; }
  else { otherWeightWrap.style.display = 'none'; document.getElementById('otherWeightInput').value = ''; }
});

function calcSeeds(){
  const spacing = parseFloat(document.getElementById('spacingInp').value);
  const area = parseFloat(document.getElementById('areaInp').value);
  const sel = cropSelect.options[cropSelect.selectedIndex];
  const crop = sel.value || 'Crop';
  let weight100 = parseFloat(sel.dataset.w || 0);

  if(crop === 'Other'){
    weight100 = parseFloat(document.getElementById('otherWeightInput').value);
    if(!weight100){ alert('Enter weight per 100 seeds for the Other crop'); return; }
  }

  if(!spacing || !area){ alert('Please enter spacing & area'); return; }
  const seeds = Math.round((area * 10000) / (spacing * spacing));
  document.getElementById('seedResult').textContent = `${crop}: Required Seeds ‚âà ${seeds.toLocaleString()}`;

  if(weight100 && weight100 > 0){
    const gramsPerSeed = weight100 / 100.0;
    const totalKg = (seeds * gramsPerSeed) / 1000.0;
    document.getElementById('seedWeightResult').textContent = `Required Weight ‚âà ${totalKg.toFixed(2)} kg`;
  } else {
    document.getElementById('seedWeightResult').textContent = 'Required Weight: ‚Äî';
  }
}

/* ======================= Moisture Monitor - Realtime via Firebase ======================= */
/* Chart setup */
const ctx = document.getElementById('moistureChart').getContext('2d');
let chartData = [50,50,50,50,50,50,50,50,50,50];
const moistureChart = new Chart(ctx, {
  type:'line',
  data:{ labels: chartData.map((_,i)=>i+1), datasets:[{ data: chartData, borderColor:'rgba(39,174,96,1)', backgroundColor:'rgba(39,174,96,0.12)', tension:0.35, fill:true }]},
  options:{ scales:{ y:{ min:0, max:100 } }, plugins:{ legend:{display:false} }, maintainAspectRatio:false }
});
function addMoisturePoint(val){
  moistureChart.data.datasets[0].data.push(val);
  if(moistureChart.data.datasets[0].data.length > 20) moistureChart.data.datasets[0].data.shift();
  moistureChart.update();
}

/* Listen to Realtime DB path /agrotech/moisture and /agrotech/updatedAt */
const moistureRef = db.ref('/agrotech/moisture');
const updatedRef = db.ref('/agrotech/updatedAt');

moistureRef.on('value', snapshot => {
  const val = snapshot.val();
  if(val !== null && !isNaN(val)){
    addMoisturePoint(Number(val));
  }
});
updatedRef.on('value', snap => {
  const t = snap.val();
  if(t){
    const d = new Date(t * 1000);
    document.getElementById('lastUpdated').textContent = `Last Updated: ${d.toLocaleString()}`;
  }
});
function manualRefresh(){ /* small manual fallback */ moistureRef.once('value').then(s=>{ const v=s.val(); if(v!==null) addMoisturePoint(Number(v)); }); }

/* ======================= Profile actions ======================= */
function updateName(){
  const newName = document.getElementById('editName').value.trim();
  if(!newName) return alert('Enter a name');
  const user = auth.currentUser;
  user.updateProfile({ displayName: newName }).then(()=>{
    document.getElementById('p-name').textContent = newName;
    document.getElementById('welcomeTitle').textContent = `Welcome, ${newName}`;
    document.getElementById('profileAvatar').textContent = newName.charAt(0).toUpperCase();
    alert('Name updated');
  }).catch(err=> alert(err.message));
}
function deleteAccount(){
  if(!confirm('Are you sure? This will permanently delete your account.')) return;
  const user = auth.currentUser;
  user.delete().then(()=>{ alert('Account deleted'); location.reload(); }).catch(err=>{
    if(err.code === 'auth/requires-recent-login') alert('Please sign out and sign in again before deleting your account.');
    else alert(err.message);
  });
}

/* ======================= Parallax mouse move ======================= */
const bgImage = document.getElementById('bgImage');
document.addEventListener('mousemove', (e) => {
  const w = window.innerWidth, h = window.innerHeight;
  const nx = (e.clientX - w/2) / (w/2);
  const ny = (e.clientY - h/2) / (h/2);
  bgImage.style.transform = `translate3d(${nx*8}px, ${ny*6}px, 0) scale(1.06)`;
});

/* ======================= Initial UI adjustments ======================= */
/* Hide auth overlay if already signed in is handled by auth listener */
auth.onAuthStateChanged(user => {
  if(user){
    authPanel.style.display='none';
    // show default dashboard
    navClick('dashboard');
  }
});

/* ======================= Accessibility / keyboard helper ======================= */
document.addEventListener('keydown', e => {
  if(e.key === 'Escape'){ /* could close overlays etc */ }
});
</script>

</body>
</html>
